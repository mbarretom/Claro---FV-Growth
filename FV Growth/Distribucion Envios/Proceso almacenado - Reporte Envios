-- ==========================================
-- 🗑️ PASO 1: ELIMINAR TABLAS SI EXISTEN
-- ==========================================

DROP TABLE INNOVACION.TBL_TOTAL_ENVIOS;
DROP TABLE INNOVACION.TBL_PRIMER_TOQUE;



-- ==========================================
-- 🗑️ PASO 2: TOTAL DE ENVIOS
-- ==========================================
CREATE MULTISET TABLE INNOVACION.TBL_TOTAL_ENVIOS AS
(
    SELECT
        FECHA_ENVIO,
        MESSAGE_TYPE,
        BUSINESS_UNIT,
        CHANNEL,
        SEGMENT,
        PRODUCT,
        SUBPRODUCT,
        NEMOTECNIA,
        COUNT(*) AS ENVIOS_TOTALES,
        COUNT(DISTINCT TELE_NUMB) AS USUARIOS_UNICOS
    FROM
    (
        /* 1️⃣ Filtramos y deduplicamos desde el inicio */
        SELECT
            CAST(T.FECHA AS DATE) AS FECHA_ENVIO,
            O.MESSAGE_TYPE,
            O.BUSINESS_UNIT,
            O.CHANNEL,
            O.SEGMENT,
            O.PRODUCT,
            O.SUBPRODUCT,
            O.NEMOTECNIA,
            T.TELE_NUMB
        FROM INNOVACION.VW_TBL_FACT_AUT_TCM T
        INNER JOIN INNOVACION.GROWTH_CAMPAIGN_OPTION O
            ON T.NEMOTECNIA = O.NEMOTECNIA
        WHERE T.BAN_AUTORIZACION_ENVIO = 'SI'
          AND T.FECHA >= ADD_MONTHS(TRUNC(CURRENT_DATE, 'MM'), -1)
          AND T.FECHA <  ADD_MONTHS(TRUNC(CURRENT_DATE, 'MM'), 1)
        QUALIFY ROW_NUMBER() OVER (
            PARTITION BY T.TELE_NUMB, O.NEMOTECNIA, CAST(T.FECHA AS DATE)
            ORDER BY T.FECHA DESC
        ) = 1
    ) SRC
    GROUP BY
        FECHA_ENVIO, MESSAGE_TYPE, BUSINESS_UNIT, CHANNEL, SEGMENT, PRODUCT, SUBPRODUCT, NEMOTECNIA
) WITH DATA
PRIMARY INDEX (NEMOTECNIA);



-- ==========================================
-- 🎯 PASO 3: CREAR TABLA - PRIMER TOQUE
-- ==========================================

CREATE TABLE INNOVACION.TBL_PRIMER_TOQUE AS (
    WITH datos_envios AS (
        SELECT
            CAST(T.FECHA AS DATE) AS FECHA_ENVIO,
            T.TELE_NUMB,
            O.MESSAGE_TYPE,
            O.BUSINESS_UNIT,
            O.CHANNEL,
            O.SEGMENT,
            O.PRODUCT,
            O.SUBPRODUCT,
            O.NEMOTECNIA,
            TRUNC(T.FECHA, 'MONTH') AS PRIMER_DIA_MES
        FROM INNOVACION.VW_TBL_FACT_AUT_TCM T
        JOIN INNOVACION.GROWTH_CAMPAIGN_OPTION O
            ON T.NEMOTECNIA = O.NEMOTECNIA
        WHERE T.BAN_AUTORIZACION_ENVIO = 'SI'
            AND TRUNC(T.FECHA, 'MONTH') IN (
                TRUNC(CURRENT_DATE, 'MONTH'),
                TRUNC(ADD_MONTHS(CURRENT_DATE, -1), 'MONTH')
            )
    ),
    primer_toque_por_producto AS (
        SELECT
            FECHA_ENVIO,
            TELE_NUMB,
            MESSAGE_TYPE,
            BUSINESS_UNIT,
            CHANNEL,
            SEGMENT,
            PRODUCT,
            SUBPRODUCT,
            NEMOTECNIA,
            PRIMER_DIA_MES,
            ROW_NUMBER() OVER (
                PARTITION BY TELE_NUMB, PRODUCT, PRIMER_DIA_MES
                ORDER BY FECHA_ENVIO ASC
            ) AS rn
        FROM datos_envios
    )
    SELECT
        FECHA_ENVIO,
        MESSAGE_TYPE,
        BUSINESS_UNIT,
        CHANNEL,
        SEGMENT,
        PRODUCT,
        SUBPRODUCT,
        NEMOTECNIA,
        COUNT(DISTINCT TELE_NUMB) AS USUARIOS_UNICOS
    FROM primer_toque_por_producto
    WHERE rn = 1
    GROUP BY
        FECHA_ENVIO,
        MESSAGE_TYPE,
        BUSINESS_UNIT,
        CHANNEL,
        PRODUCT,
        SEGMENT,
        SUBPRODUCT,
        NEMOTECNIA
) WITH DATA
PRIMARY INDEX (NEMOTECNIA);


-- ==========================================
-- 📈 PASO 4: CONSULTA FINAL PARA POWER BI
-- ==========================================

SELECT
    COALESCE(E.FECHA_ENVIO, P.FECHA_ENVIO) AS FECHA,
    COALESCE(E.MESSAGE_TYPE, P.MESSAGE_TYPE) AS MESSAGE_TYPE,
    COALESCE(E.BUSINESS_UNIT, P.BUSINESS_UNIT) AS BUSINESS_UNIT,
    COALESCE(E.CHANNEL, P.CHANNEL) AS CHANNEL,
    COALESCE(E.SEGMENT, P.SEGMENT) AS CHANNEL,    
    COALESCE(E.PRODUCT, P.PRODUCT) AS PRODUCT,
    COALESCE(E.SUBPRODUCT, P.SUBPRODUCT) AS SUBPRODUCT,
    COALESCE(E.NEMOTECNIA, P.NEMOTECNIA) AS NEMOTECNIA,
    COALESCE(E.ENVIOS_TOTALES, 0) AS ENVIOS_TOTALES,
    COALESCE(E.USUARIOS_UNICOS, 0) AS USUARIOS_UNICOS,
    COALESCE(P.USUARIOS_UNICOS, 0) AS USUARIOS_PRIMER_TOQUE
FROM INNOVACION.TBL_TOTAL_ENVIOS E
FULL OUTER JOIN INNOVACION.TBL_PRIMER_TOQUE P
    ON E.NEMOTECNIA = P.NEMOTECNIA
   AND E.CHANNEL = P.CHANNEL
   AND E.SEGMENT = P.SEGMENT   
   AND E.PRODUCT = P.PRODUCT
   AND E.SUBPRODUCT = P.SUBPRODUCT
   AND E.MESSAGE_TYPE = P.MESSAGE_TYPE
   AND E.BUSINESS_UNIT = P.BUSINESS_UNIT
   AND E.FECHA_ENVIO = P.FECHA_ENVIO;
