Nombre: Atribucion Claro Pay

Descripción: Cálculo de Atribución Claro Pay 

Autor: Mateo Barreto Montealegre 
Fecha: 22/09/2025

1. Ejecución del proceso

-- Query 
        WITH ENVIOS AS (
          SELECT CAST(A.FECHA AS DATE FORMAT 'YYYY-MM-DD') AS FECHA
                ,B.MESSAGE_TYPE AS TIPO_NOTIFICACION
                ,A.DES_PLATAFORMA AS PLATAFORMA
                ,B.CHANNEL AS CANAL
                ,B.NEMOTECNIA AS NEMOTECNIA
                ,B.SEGMENT AS SEGMENTO
                ,B.CAMPAIGN_NAME AS CAMPAIGN        
                ,C.MESSAGE AS MENSAJE 
                ,RIGHT(A.TELE_NUMB,10) AS TELE_NUMB
                ,ROW_NUMBER() OVER (
                     PARTITION BY RIGHT(A.TELE_NUMB,10)
                     ORDER BY CAST(A.FECHA AS DATE FORMAT 'YYYY-MM-DD') ASC
                ) AS RN
          FROM INNOVACION.VW_TBL_FACT_AUT_TCM A
          JOIN INNOVACION.GROWTH_CAMPAIGN_OPTION B
            ON A.NEMOTECNIA = B.NEMOTECNIA 
          JOIN INNOVACION.GROWTH_CAMPAIGN_ASSETS C
            ON B.NEMOTECNIA = C.NEMOTECNIA
          WHERE B.PRODUCT = 'CLARO PAY'
            AND CAST(A.FECHA AS DATE FORMAT 'YYYY-MM-DD') 
                BETWEEN TRUNC(CURRENT_DATE,'MM') AND LAST_DAY(CURRENT_DATE)
            AND A.BAN_AUTORIZACION_ENVIO = 'SI'
      ),
      ALTAS_MONETARIAS AS (
          SELECT RIGHT(PHONE_NUMBER,10) AS TELE_NUMB 
                 ,TRUNC(B.CREATED_AT) AS FECHA 
          FROM INNOVACION.METABASE_USER A
          JOIN INNOVACION.METABASE_PROMOTION_PURCHASES B
            ON A.ID_METABASE = B.USER_ID
          WHERE "DISABLED" = 'FALSE'
            AND CAST(B.CREATED_AT - INTERVAL '5' HOUR AS DATE)
                BETWEEN TRUNC(CURRENT_DATE,'MM') AND LAST_DAY(CURRENT_DATE)
            AND STATUS = 'DELIVERED'
            AND PROMOTION_ID IN ('3','3874','4145','3906','4181','53','3280','34','4131','31','33')
      ),
      ALTAS_NO_MONETARIAS AS (SELECT USUARIO AS TELE_NUMB, FECHA FROM 
      (SELECT 
      RIGHT(B.PHONE_NUMBER,10) AS USUARIO, TRUNC(A.UPDATED_AT) AS FECHA FROM INNOVACION.METABASE_MINIAPP_USERS A
      LEFT JOIN	INNOVACION.METABASE_USER B ON A.USER_ID = B.ID_METABASE
      INNER JOIN	INNOVACION.METABASE_MINIAPPS C ON A.MINIAPP_ID = C.ID_METABASE
      WHERE TO_CHAR (A.UPDATED_AT - INTERVAL '5' HOUR, 'YYYYMMDD') BETWEEN TO_CHAR(TRUNC(CURRENT_DATE, 'MM'),'YYYYMMDD') AND TO_CHAR(LAST_DAY(CURRENT_DATE),'YYYYMMDD')
      			AND USER_ID NOT IN (SELECT USER_ID  FROM INNOVACION.METABASE_PROMOTION_PURCHASES ---- MOVIMIENTOS MONETARIOS
      			WHERE 1=1
      			AND TO_CHAR(CREATED_AT - INTERVAL '5' HOUR, 'YYYYMMDD') BETWEEN TO_CHAR(TRUNC(CURRENT_DATE, 'MM'),'YYYYMMDD') AND TO_CHAR(LAST_DAY(CURRENT_DATE),'YYYYMMDD')
      			AND STATUS = 'delivered'
      			AND PROMOTION_ID NOT IN (3842))
      UNION
      SELECT 
          RIGHT(B.PHONE_NUMBER,10)  AS USUARIO,
          TRUNC(LAST_SIGN_IN_AT) AS FECHA
      FROM INNOVACION.METABASE_USER B
      WHERE 1 = 1
      AND EXTRACT(YEAR FROM (LAST_SIGN_IN_AT - INTERVAL '5' HOUR)) = EXTRACT(YEAR FROM CURRENT_DATE)
      AND EXTRACT(MONTH FROM (LAST_SIGN_IN_AT - INTERVAL '5' HOUR)) = EXTRACT(MONTH FROM CURRENT_DATE)
      AND ID_METABASE NOT IN (
          SELECT USER_ID
          FROM INNOVACION.METABASE_PROMOTION_PURCHASES
          WHERE 1=1
          AND EXTRACT(YEAR FROM (CREATED_AT - INTERVAL '5' HOUR)) = EXTRACT(YEAR FROM CURRENT_DATE)
          AND EXTRACT(MONTH FROM (CREATED_AT - INTERVAL '5' HOUR)) = EXTRACT(MONTH FROM CURRENT_DATE)
          AND STATUS = 'delivered'
          AND PROMOTION_ID NOT IN (3842)
          UNION    
          SELECT A.USER_ID
          FROM INNOVACION.METABASE_MINIAPP_USERS A
          LEFT JOIN INNOVACION.METABASE_MINIAPPS B
          ON A.MINIAPP_ID = B.ID_METABASE
          WHERE 1=1 
          AND EXTRACT(YEAR FROM (A.UPDATED_AT - INTERVAL '5' HOUR)) = EXTRACT(YEAR FROM CURRENT_DATE)
          AND EXTRACT(MONTH FROM (A.UPDATED_AT - INTERVAL '5' HOUR)) = EXTRACT(MONTH FROM CURRENT_DATE)
      )) A),
      ALTAS_REGISTROS AS (
      	SELECT RIGHT(PHONE_NUMBER,10) AS TELE_NUMB
      		   ,TRUNC(A.CREATED_AT) AS FECHA 
      	FROM INNOVACION.METABASE_USER A
      	WHERE "DISABLED" = 'FALSE'
      	  AND CAST(A.CREATED_AT - INTERVAL '5' HOUR AS DATE)
      	      BETWEEN TRUNC(CURRENT_DATE,'MM') AND LAST_DAY(CURRENT_DATE)
      )
      SELECT   
             A.FECHA
            ,A.TIPO_NOTIFICACION
            ,A.PLATAFORMA
            ,A.CANAL
            ,A.CAMPAIGN        
            ,A.MENSAJE
            ,A.SEGMENTO
            ,COUNT(DISTINCT A.FECHA ||CANAL|| A.NEMOTECNIA||A.PLATAFORMA|| A.TELE_NUMB) AS ENVIOS
            ,COUNT(DISTINCT CASE 
                 WHEN A.RN = 1 THEN A.TELE_NUMB 
               END) AS PRIMER_TOQUE
            ,COUNT(CASE 
                 WHEN CAST(B.FECHA AS DATE FORMAT 'YYYYMMDD') 
                      BETWEEN CAST(A.FECHA AS DATE FORMAT 'YYYYMMDD') 
                      AND (CAST(A.FECHA AS DATE FORMAT 'YYYYMMDD') + INTERVAL '7' DAY)
                 THEN B.TELE_NUMB 
               END) AS TRANSACCIONES
            ,COUNT(DISTINCT CASE 
                 WHEN CAST(B.FECHA AS DATE FORMAT 'YYYYMMDD') 
                      BETWEEN CAST(A.FECHA AS DATE FORMAT 'YYYYMMDD') 
                      AND (CAST(A.FECHA AS DATE FORMAT 'YYYYMMDD') + INTERVAL '7' DAY)
                 THEN B.TELE_NUMB 
               END) AS USUARIOS_UNICOS_TRANSANDO
            ,COUNT(DISTINCT CASE 
                 WHEN CAST(D.FECHA AS DATE FORMAT 'YYYYMMDD') 
                      BETWEEN CAST(A.FECHA AS DATE FORMAT 'YYYYMMDD') 
                      AND (CAST(A.FECHA AS DATE FORMAT 'YYYYMMDD') + INTERVAL '7' DAY)
                 THEN D.TELE_NUMB 
               END) AS NO_MONETARIO         
            ,COUNT(DISTINCT CASE 
                 WHEN CAST(C.FECHA AS DATE FORMAT 'YYYYMMDD') 
                      BETWEEN CAST(A.FECHA AS DATE FORMAT 'YYYYMMDD') 
                      AND (CAST(A.FECHA AS DATE FORMAT 'YYYYMMDD') + INTERVAL '7' DAY)
                 THEN C.TELE_NUMB 
               END) AS USUARIOS_UNICOS_REGISTRANDO
      FROM ENVIOS A
      LEFT JOIN ALTAS_MONETARIAS B
             ON A.TELE_NUMB = B.TELE_NUMB 
      LEFT JOIN ALTAS_REGISTROS C 
      	   ON A.TELE_NUMB = C.TELE_NUMB 
      LEFT JOIN ALTAS_NO_MONETARIAS D 
      	   ON A.TELE_NUMB = D.TELE_NUMB  
      GROUP BY 1,2,3,4,5,6,7
      ;


--Power BI 
El proceso está ligado a un Dashboard en Power BI que se actualiza de manera automática con la siguiente URL: 
https://app.powerbi.com/links/m88_34tkUv?ctid=46bb22b8-4c2c-40ff-8360-7b6334821279&pbi_source=linkShare

Nombre del Dashboard: Resultados de Campañas - Claro Pay 
